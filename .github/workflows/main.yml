name: Replace Xano URL

on:
  workflow_dispatch:
    inputs:
      old_url:
        description: 'Old Xano domain (without https://)'
        required: true
        default: 'x8ki-letl-twmt.n7.xano.io'
      new_url:
        description: 'New Xano domain (without https://)'
        required: true
        default: 'xgeu-jqgf-nnju.n7e.xano.io'

jobs:
  replace-url:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and replace Xano URL
        id: replace
        run: |
          # Count files before replacement
          FILE_COUNT=$(grep -rl "${{ github.event.inputs.old_url }}" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.env*" --include="*.md" . 2>/dev/null | wc -l)
          
          echo "Found $FILE_COUNT files containing the old URL"
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            # Show which files will be changed
            echo "Files to be updated:"
            grep -rl "${{ github.event.inputs.old_url }}" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.env*" --include="*.md" . 2>/dev/null
            
            # Perform the replacement
            find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" -o -name "*.env*" -o -name "*.md" \) -exec sed -i "s/${{ github.event.inputs.old_url }}/${{ github.event.inputs.new_url }}/g" {} +
            
            echo "Replacement complete!"
          fi

      - name: Create Pull Request
        if: steps.replace.outputs.file_count > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: migrate Xano URL to new instance"
          title: "ðŸ”„ Migrate Xano API URL to new instance"
          body: |
            ## Xano URL Migration
            
            This PR automatically replaces all instances of the old Xano URL with the new one.
            
            | Old URL | New URL |
            |---------|---------|
            | `${{ github.event.inputs.old_url }}` | `${{ github.event.inputs.new_url }}` |
            
            ### Files Changed
            Run the workflow to see the full diff.
            
            ### Next Steps
            1. Review the changes in the "Files changed" tab
            2. Test locally or in preview deployment
            3. Merge when ready
            
            ---
            *Generated by GitHub Actions workflow*
          branch: chore/migrate-xano-url
          delete-branch: true

      - name: No changes found
        if: steps.replace.outputs.file_count == 0
        run: |
          echo "No files found containing the old URL: ${{ github.event.inputs.old_url }}"
          echo "Nothing to update!"
